<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="../../assets/ico/favicon.png">

	<title>Search Safety Audit Forms</title>

	<link href="bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet">
	<link href="css/typeahead-bootstraptheme.css" rel="stylesheet">
	<link href="css/bge-bootstrap.css" rel="stylesheet">
	<link href="css/animate.css" rel="stylesheet">
	<script src="bower_components/sprockets-modernizr/modernizr.js"></script>
	<script src="js/services_config.js"></script>
	<script src="js/login.js"></script>
</head>
<body><nav id="nav" role="navigation">
    <div class="block">
        <div class='offline_status'>
            You are operating in offline mode, please login before submitting
            
            <button class="btn btn-primary btn-block" data-toggle="modal" data-target="#quickLogin">
			  Login
			</button>
        </div>
        <div class='logged_in_as' style='display:none'></div>

        <ul>
            <li><a href="drafts.html">Drafts <span class="badge" id='drafts_count'></span></a></li>
            <li><a href="bootstrap-form.html" id="safety_audit_link">New Safety Audit Form</a></li>
            <li><a href="bootstrap-form.html?type=peertopeer" id="peet_to_peer_link">New Peer to Peer Observation</a></li>
            
            <!-- <li><a href="">Management Form</a></li> -->
            <!-- <li><a href="">Level 1 Report</a></li> -->
            <li><a href="bootstrap-search.html" id='search_audit_link'>Search Forms</a></li>
            <!-- <li><a href="bootstrap-photo.html">Photo Upload</a></li> -->
            <li><a href="index.html" id="logout_link">Logout</a></li>
        </ul>
        <a class='settings_link' href="settings.html"><span class='glyphicon glyphicon-cog'></span>Settings &amp; Info</a>

        <a class='settings_link' href="#" id="help_link"><span class='glyphicon glyphicon-exclamation-sign'></span>Help!</a>        
        <p id="help_text">Please contact the <br>"iPad Safety App" group at <a href="mailto:iPadSafetyApp@exeloncorp.com">iPadSafetyApp@exeloncorp.com</a> <br>for support</p>
    </div>
</nav>

<div id='main'>
    <header id="top" role="banner">
    <div class="block">
        <h1>EU Safety Audit App</h1>
        <div class="nav-btn" id="nav-open-btn">Navigation</div>
    </div>
    </header>

    <article id='main-content'>
	<div class="container theme-showcase">
		<form action="testing" method="POST" role="form" onsubmit="return false;">

			<div class="row">
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
					<label class='control-label'>AR Number</label>
					<input class="form-control" type="text" size="50" name="ARNumber">

					<label class='control-label hidden'>AuditorId</label>
					<input class="form-control hidden" type="text" size="50" name="AuditorId">
					

					
					
					

					
					<label class='control-label hidden'>AuditeeId</label>
					<input class="form-control hidden" type="text" size="50" name="AuditeeId">
					

					
					<label class='control-label hidden'>AuditeeName</label>
					<input class="form-control hidden" type="text" size="50" name="AuditeeName">

					<label class='control-label hidden'>ApprovedById</label>
					<input class="form-control hidden" type="text" size="50" name="ApprovedById">
					

					
					<label class='control-label hidden'>ApprovedByName</label>
					<input class="form-control hidden" type="text" size="50" name="ApprovedByName">
					

					
					<label class='control-label hidden'>CreatedById</label>
					<input class="form-control hidden" type="text" size="50" name="CreatedById">
					

					
					<label class='control-label hidden'>CreatedByName</label>
					<input class="form-control hidden" type="text" size="50" name="CreatedByName">
					

					
					<label class='control-label hidden'>SupervisorManagerId</label>
					<input class="form-control hidden" type="text" size="50" name="SupervisorManagerId">
					

					
					<label class='control-label hidden'>SupervisorManagerName</label>
					<input class="form-control hidden" type="text" size="50" name="SupervisorManagerName">

					<label class='control-label'>Auditor Facility</label>
					
					<select name="ReportingDepartmentFacilityId" id="ReportingDepartmentFacilityId" class="form-control" title='Select a facility'>
						<option value="">Select...</option>
						<option value="CED">ComEd</option>
						<option value="PDS">PECO</option>
						<option value="BSC">BSC</option>
						<option value="BGE" selected>BGE</option>
					</select>
					

					<label class='control-label hidden'>Auditor Department</label>
					<select class="form-control hidden" id="ReportingDepartmentId" name="ReportingDepartmentId">
						<option value=""></option>
					</select>
					
					<label class='control-label'>Auditee Facility</label>
					<select name="ResponsibleDepartmentFacilityId" id="ResponsibleDepartmentFacilityId" class="form-control" title='Select a facility'>
						<option value="">Select...</option>
						<option value="CED">ComEd</option>
						<option value="PDS">PECO</option>
						<option value="BSC">BSC</option>
						<option value="BGE">BGE</option>
					</select>

					<label class='control-label hidden'>Auditee Department</label>
					<select name="ResponsibleDepartmentId" id="ResponsibleDepartmentId" class="form-control hidden">
						<option value=""></option>
					</select>

				</div>
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
				

					<label class='control-label'>Filter Entry Date from Start Date</label>
					<input class="form-control" type="date" size="50" name="StartEventDate">
					

					
					<label class='control-label'>Filter Entry Date till End Date</label>
					<input class="form-control" type="date" size="50" name="EndEventDate">

					<label class='control-label'>Auditor Name</label>
					<input class="form-control" type="text" size="50" name="AuditorName">
					<span>Enter first or last name, but not both</span>

					<!-- <label class='control-label'>SortField</label> -->
					<input class="form-control" type="hidden" size="50" name="SortField">
					

					
					<!-- <label class='control-label'>SortDirection</label> -->
					<input class="form-control" type="hidden" size="50" name="SortDirection">
				</div>
			</div>





















			<button value="Search" id='search' class="btn btn-primary btn-block" style='margin-top:20px' data-loading-text=" <span class='glyphicon glyphicon-refresh fa-spin'></span> Searching...">
				
				Search
			</button>
		</form>

		<h3 class='section_header'>Results</h3>

		<table class='table table-bordered table-striped' id='search_results'>
			<thead>
				<tr>
					<th>AR ID</th>
					<th>Category</th>
					<th>Auditor</th>
					<th>Auditee Facility &amp; Department</th>
					<th>Date</th>
					<th>Status</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>


	</div> <!-- /container -->



</article>
</div>
</div>



<!-- Modal -->
<div class="modal fade" id="quickLogin" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Login</h4>
      </div>
      <div class="modal-body">
        

        <p id="quick_login_reason"></p>

	    <p id="quick_login_statement">Please use Layer 7 credentials</p>

	    <input type="text" name="quick_login_username" id="quick_login_username" class="form-control" value="" required="required" title="" placeholder='Username' required>

	    <input type="password" name="quick_login_password" id="quick_login_password" class="form-control" value="" required="required" title="" placeholder='Password' required>

	    <button class="btn btn-primary btn-lg btn-block" id='quick_login_loginbutton' value='Login' data-loading-text=" <span class='glyphicon glyphicon-refresh fa-spin'></span> Logging in..." />Login</button>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class='tinyalert' id="draftAlert">
	Saving Draft
</div>
<div class='tinyalert' id="loadingFromServer">
	Saving Draft
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="bower_components/fastclick/lib/fastclick.js"></script>
<script src="bower_components/typeahead.js/dist/typeahead.bundle.js"></script>
<script src="bower_components/momentjs/moment.js"></script>
<script src="bower_components/hammerjs/hammer.min.js"></script>

<script src="js/handlebars.js"></script>
<script src="js/jquery.validate.js"></script>
<script src="js/jquery.validate.bootstrap.js"></script>
<script src="js/drafts-db.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/ImageMetaDataReader.js"></script>
<script src="js/menu.js"></script>
	<script>
	var statusCodeToString = {
			"20" : "In Revision",
			"25" : "Rejected",
			"30" : "H/Approved",
			"35" : "Pre-approved",
			"38" : "Notify",
			"40" : "Approved",
			"85" : "Completed",
			"86" : "Comp NA",
			"95" : "Canceled",
			}

	$(function(){
		FastClick.attach(document.body);

		// setupFacilityListener("#ReportingDepartmentFacilityId", "#ReportingDepartmentId", undefined);
		// setupFacilityListener("#ResponsibleDepartmentFacilityId", "#ResponsibleDepartmentId", "#ResponsibleOfficeCode");


		var weekago = moment().subtract('days', 7).toDate();

		// Applies the time zone offset. valueAsDate takes in UTC
		// document.getElementById('EventDate').valueAsDate = weekago - weekago.getTimezoneOffset()*60*1000;
		$('input[name="StartEventDate"]')[0].valueAsDate = weekago - weekago.getTimezoneOffset()*60*1000;

		function setupFacilityListener(facility_dropdown, department_dropdown, office_dropdown){
			$(facility_dropdown).change(function(){
				$(department_dropdown).html("<option disabled>Loading...</option>").addClass('loading');
				$.ajax({
					url: services.getSelectedL7Base() + "DepartmentLookup?query",
					type: 'POST',
					headers: {
						// "cache-control": "no-cache",
						"Authorization" : "Bearer "+localStorage.oauthtoken,
					},
					data: JSON.stringify({ "facility": $(this).val() }),
					contentType: "application/json; charset=utf-8",
					dataType: 'JSON',
					success: function(data){
						$(department_dropdown).html("<option value=''></option>");
						for(var i = 0; i < data.d.length; i++){
							$(department_dropdown).append("<option value='" + data.d[i].Value + "'>" + data.d[i].Name + "</option>");
						}
						$(department_dropdown).removeClass('loading');
					},
					error: function(data){
						if(data.status == 401){
							alert('Unauthorized! Your login may have expired. Please logout and log back in.')
						}
						else{
							alert('Service call failed!');
						}
						$(department_dropdown).removeClass('loading').html("<option disabled>Loading Failed!</option>");
					}
				});

			});


		}

		$("#search").click(function(){
			if(localStorage.oauthtoken == undefined){
				$('#quickLogin').modal('show');
				$('#quickLogin #quick_login_reason').text("You will need to login before searching.");
				return;
			}
			var startDate = moment($('input[name="StartEventDate"]').val()).format('YYYYMMDD');
			if(startDate === "Invalid date")
				startDate = "";

			var endDate = moment($('input[name="EndEventDate"]').val()).format('YYYYMMDD');
			if(endDate === "Invalid date")
				endDate = "";

			var formObject = {
				"ARNumber" : $('input[name="ARNumber"]').val(),
				"AuditorId" : $('input[name="AuditorId"]').val(),
				"AuditorName" : $('input[name="AuditorName"]').val(),
				"AuditeeId" : $('input[name="AuditeeId"]').val(),
				"AuditeeName" : $('input[name="AuditeeName"]').val(),
				"ReportingDepartmentFacilityId" : $('select[name="ReportingDepartmentFacilityId"]').val(),
				"ReportingDepartmentId" : $('select[name="ReportingDepartmentId"] option:selected').text(),
				"ResponsibleDepartmentFacilityId" : $('select[name="ResponsibleDepartmentFacilityId"]').val(),
				"ResponsibleDepartmentId" : $('select[name="ResponsibleDepartmentId"] option:selected').text(),
				"StartEventDate" : startDate,
				"EndEventDate" : endDate,
				"ApprovedById" : $('input[name="ApprovedById"]').val(),
				"ApprovedByName" : $('input[name="ApprovedByName"]').val(),
				"CreatedById" : $('input[name="CreatedById"]').val(),
				"CreatedByName" : $('input[name="CreatedByName"]').val(),
				"SupervisorManagerId" : $('input[name="SupervisorManagerId"]').val(),
				"SupervisorManagerName" : $('input[name="SupervisorManagerName"]').val(),
				"SortField" : $('input[name="SortField"]').val(),
				"SortDirection" : $('input[name="SortDirection"]').val(),
				"PageNumber"  : "1",
				"PageSize"  : "500"
			}

			$(this).button('loading');

			$.ajax({
				url: services.getSelectedL7Base() + "SearchAR",
				type: 'POST',
				headers: {
					// "cache-control": "no-cache",
					"Authorization" : "Bearer "+localStorage.oauthtoken,
				},
				data: JSON.stringify(formObject),
				contentType: "application/json; charset=utf-8",
				dataType: 'JSON',
				success: function(data){
					$("#search_results tbody").html("");
					if(data.d.SearchRecords != null){
						$.each(data.d.SearchRecords, function(i, result){
							// console.log(result);
							$("<tr>").append("<td><a href='bootstrap-form.html?viewid=" + result.ARID + "'>" + result.ARID + "</a></td>")
							.append("<td>" + result.category + "</td>")
							.append("<td>" + result.auditor + "</td>")
							.append("<td>" + result.auditeeFac + " - " + result.auditeeDep + "</td>")
							.append("<td>" + moment(result.eventDate, "YYYYMMDD").format("MM/DD/YYYY") + "</td>")
							.append("<td>" + statusCodeToString[result.status] + "</td>")
							.appendTo("#search_results tbody");
						});

						var position = $("#search_results").position();

						$('html, body').animate({scrollTop: position.top-150}, 1000);
					}
					else{
						alert('No search results! Try changing your search parameters.');
					}
					// $("#search_results tbody").append()
					$("#search").button('reset');
				},
				error: function(data){
					if(data.status == 401){
						alert('Unauthorized! Your login may have expired. Please logout and log back in.')
					}
					else{
						alert('Service call failed!');
					}
					$("#search").button('reset');
				}
			});
	});

})
</script>